<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teleprompt - Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background-color: #7c6bca;
        }
    </style>
    <link rel="icon" href="static/img/Teleprompt.io ICON.ico" type="image/x-icon">
</head>
<body class="min-h-screen gradient-bg">
    <!-- Moving Emoji Mesh Canvas -->
    <canvas id="emojiMesh" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;pointer-events:none;"></canvas>
    <div class="container mx-auto px-4 py-8" style="position:relative;z-index:1;">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 text-center">
                {% if game.gamemode == 'inverted' %}
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Inverted Game Complete!</h1>
                <p class="text-gray-600">Here's the creative journey from drawing to AI analysis</p>
                {% else %}
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Game Complete!</h1>
                <p class="text-gray-600">Here's the creative journey your group took</p>
                {% endif %}
                <a href="/" class="inline-block mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Play Again
                </a>
            </div>

            <!-- Results Chain -->
            <div class="space-y-6">
                {% for i in range(game.players|length) %}
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- Image -->
                            {% if not (game.gamemode != 'inverted' and i == 0) %}
                            {% if game.gamemode == 'inverted' %}
                            <h4 class="text-2xl font-bold text-gray-700 mb-4">{{ game.players[i].name }}'s Drawing:</h4>
                            {% endif %}
                            <div class="aspect-video bg-gray-100 rounded-lg overflow-hidden">
                                {% if i < game.images|length and game.images[i] %}
                                <img src="/{{ game.images[i].path }}" 
                                     alt="Generated image for round {{ i + 1 }}" 
                                     class="w-full h-full object-cover">
                                {% else %}
                                <div class="w-full h-full flex items-center justify-center text-gray-500">
                                    <div class="text-center">
                                        <div class="text-4xl mb-2">üñºÔ∏è</div>
                                        <p>No image available</p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Prompt/Description -->
                            <div>
                                {% if game.gamemode == 'inverted' %}
                                <h4 class="text-2xl font-bold text-gray-700 mb-4">AI Analysis:</h4>
                                <div class="bg-blue-50 rounded-lg p-6">
                                    {% if i < game.descriptions|length and game.descriptions[i] %}
                                    <p class="text-4xl text-gray-800 italic font-medium leading-relaxed">"{{ game.descriptions[i].text }}"</p>
                                    {% else %}
                                    <p class="text-4xl text-gray-500 italic font-medium">No AI analysis available (timeout)</p>
                                    {% endif %}
                                </div>
                                {% else %}
                                <h4 class="text-2xl font-bold text-gray-700 mb-4">
                                    {% if i == 0 %}
                                        {{ game.players[i].name }}'s Starting Prompt:
                                    {% else %}
                                        {{ game.players[i].name }}'s Prompt:
                                    {% endif %}
                                </h4>
                                <div class="bg-gray-50 rounded-lg p-6">
                                    {% if i < game.prompts|length and game.prompts[i] %}
                                    <p class="text-4xl text-gray-800 italic font-medium leading-relaxed">"{{ game.prompts[i].text }}"</p>
                                    {% else %}
                                    <p class="text-4xl text-gray-500 italic font-medium">No prompt provided (timeout)</p>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center my-4">
                    <span id="chain-arrow-{{i}}" class="text-[8rem] font-extrabold drop-shadow-lg transition-colors duration-300 bg-gradient-to-b from-yellow-400 to-purple-600 bg-clip-text text-transparent">
                        ‚Üì
                    </span>
                </div>
                <script>
                    // Arrow color change on scroll
                    window.addEventListener('scroll', function() {
                        const arrow = document.getElementById('chain-arrow-{{i}}');
                        if (!arrow) return;
                        const rect = arrow.getBoundingClientRect();
                        const percent = rect.top / window.innerHeight;
                        // percent: 1 = top of viewport, 0 = bottom
                        // Transition from yellow (>=0.6) to purple (<=0.4)
                        let yellow = Math.min(1, Math.max(0, (percent - 0.4) / 0.2));
                        let purple = 1 - yellow;
                        // Set gradient via inline style
                        arrow.style.backgroundImage = `linear-gradient(to bottom, rgba(251,191,36,${yellow}) 0%, rgba(168,85,247,${purple}) 100%)`;
                    });
                </script>
                {% endfor %}
                
                {% if game.gamemode != 'inverted' %}
                <!-- Final Thank You Card -->
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="p-6">

                        <div class="space-y-4">
                            <!-- Final Image -->
                            <div class="aspect-video bg-gray-100 rounded-lg overflow-hidden">
                                {% if game.images|length > 0 and game.images[-1] %}
                                <img src="/{{ game.images[-1].path }}" 
                                     alt="Final generated image" 
                                     class="w-full h-full object-cover">
                                {% else %}
                                <div class="w-full h-full flex items-center justify-center text-gray-500">
                                    <div class="text-center">
                                        <div class="text-4xl mb-2">üñºÔ∏è</div>
                                        <p>No final image available</p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Thank You Message -->
                            <div>
                                <h4 class="text-2xl font-bold text-gray-700 mb-4">Message:</h4>
                                <div class="bg-green-50 rounded-lg p-6">
                                    <p class="text-4xl text-gray-800 font-bold leading-relaxed">Thank you for playing!</p>
                                    <p class="text-2xl text-gray-600 font-medium mt-4">We hope you enjoyed the creative journey!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Summary -->
            <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Game Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">{{ game.players|length }}</div>
                        <div class="text-sm text-gray-600">Players</div>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        {% if game.gamemode == 'inverted' %}
                        <div class="text-2xl font-bold text-green-600">{{ game.descriptions|length }}</div>
                        <div class="text-sm text-gray-600">AI Analyses</div>
                        {% else %}
                        <div class="text-2xl font-bold text-green-600">{{ game.prompts|length }}</div>
                        <div class="text-sm text-gray-600">Prompts</div>
                        {% endif %}
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600">
                            {% if game.gamemode == 'inverted' %}
                                {{ game.images|length }}
                            {% else %}
                                {{ game.images|length - 1 }}
                            {% endif %}
                        </div>
                        <div class="text-sm text-gray-600">Images</div>
                    </div>
                </div>
            </div>

            <!-- Share Section -->
            <div class="mt-6 bg-white rounded-lg shadow-lg p-6 text-center">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Share Your Game</h3>
                <p class="text-gray-600 mb-4">Invite friends to play the next round!</p>
                <div class="flex justify-center space-x-4">
                    <button onclick="copyRoomCode()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                        Copy Room Code
                    </button>
                    <button onclick="shareResults()" 
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                        Share Results
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function copyRoomCode() {
            const roomCode = window.location.pathname.split('/').pop();
            navigator.clipboard.writeText(roomCode).then(() => {
                alert('Room code copied to clipboard!');
            });
        }

        function shareResults() {
            if (navigator.share) {
                navigator.share({
                    title: 'Check out our Teleprompt game results!',
                    text: 'We just finished an amazing AI drawing game. Check out the creative chain we made!',
                    url: window.location.href
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                copyRoomCode();
            }
        }

        // Emoji Mesh Physics Simulation
        const canvas = document.getElementById('emojiMesh');
        const ctx = canvas.getContext('2d');
        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        const phoneEmoji = 'üìû';
        const brainEmoji = 'üß†';
        const gridCols = Math.floor(width / 70)+1;
        const gridRows = Math.floor(height / 70)+1;
        const spacing = 69;
        const mesh = [];
        const springs = [];
        let mouse = {x: -1000, y: -1000};
        // Node structure: {x, y, vx, vy, baseX, baseY, emoji}
        for (let r = 0; r < gridRows; r++) {
            for (let c = 0; c < gridCols; c++) {
                mesh.push({
                    x: c * spacing + spacing/2,
                    y: r * spacing + spacing/2,
                    vx: 0,
                    vy: 0,
                    baseX: c * spacing + spacing/2,
                    baseY: r * spacing + spacing/2,
                    emoji: (r + c) % 2 === 0 ? phoneEmoji : brainEmoji
                });
            }
        }
        // Connect springs (adjacent nodes)
        function nodeIdx(r, c) { return r * gridCols + c; }
        for (let r = 0; r < gridRows; r++) {
            for (let c = 0; c < gridCols; c++) {
                let idx = nodeIdx(r, c);
                if (c < gridCols - 1) springs.push([idx, nodeIdx(r, c+1)]);
                if (r < gridRows - 1) springs.push([idx, nodeIdx(r+1, c)]);
            }
        }
        // Mouse interaction
        window.addEventListener('mousemove', e => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });
        window.addEventListener('mouseleave', () => {
            mouse.x = -1000; mouse.y = -1000;
        });
        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        });
        function stepPhysics() {
            // Spring forces
            for (const [i, j] of springs) {
                const a = mesh[i], b = mesh[j];
                const dx = b.x - a.x, dy = b.y - a.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const rest = spacing;
                const force = 0.02 * (dist - rest); // reduced spring force for slower movement
                const fx = force * dx / (dist || 1);
                const fy = force * dy / (dist || 1);
                a.vx += fx; a.vy += fy;
                b.vx -= fx; b.vy -= fy;
            }
            // Jiggle/ripple
            for (const node of mesh) {
                // Restore to base position
                const dx = node.baseX - node.x;
                const dy = node.baseY - node.y;
                node.vx += 0.004 * dx + (Math.random()-0.5)*0.02; // slower restoration and less random jiggle
                node.vy += 0.004 * dy + (Math.random()-0.5)*0.02;
                // Mouse repulsion
                const mx = node.x - mouse.x;
                const my = node.y - mouse.y;
                const mdist = Math.sqrt(mx*mx + my*my);
                if (mdist < 120) {
                    const repulse = 2 * (1 - mdist/120);
                    node.vx += repulse * mx/(mdist||1);
                    node.vy += repulse * my/(mdist||1);
                }
                // Damping
                node.vx *= 0.75;
                node.vy *= 0.75;
                node.x += node.vx;
                node.y += node.vy;
            }
        }
        function drawMesh() {
            ctx.clearRect(0, 0, width, height);
            ctx.font = '40px serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.save();
            ctx.globalAlpha = 0.5; // half transparency for all emojis
            for (const node of mesh) {
                ctx.fillText(node.emoji, node.x, node.y);
            }
            ctx.restore();
        }
        function animate() {
            stepPhysics();
            drawMesh();
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
